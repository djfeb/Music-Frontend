"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1322],{2401:(e,t,r)=>{r.d(t,{firebaseService:()=>n});var a=r(5317),i=r(8915);async function o(e){return new Promise(t=>setTimeout(t,e))}async function s(e,t){let r,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=0;for(;s<=a;)try{s>0&&console.debug("[Firestore][retry] Attempt ".concat(s,"/").concat(a," for"),t);let r=await e();return s>0&&console.debug("[Firestore][retry] Succeeded after ".concat(s," retries for"),t),r}catch(n){r=n;let e=null==n?void 0:n.code;if("unavailable"!==e&&"deadline-exceeded"!==e&&"internal"!==e&&"resource-exhausted"!==e||s===a)throw console.error("[Firestore][retry] Failed ".concat(t),{attempt:s,code:e,err:n}),n;let l=i*Math.pow(2,s);await o(l),s++}throw r}class l{initConnectivityHandling(){let e=async()=>{try{navigator.onLine?(console.debug("[Firestore][net] Enabling network (online)"),await (0,a.Os)(i.db)):(console.debug("[Firestore][net] Disabling network (offline)"),await (0,a.LA)(i.db))}catch(e){console.warn("[Firestore][net] Failed to toggle network",e)}};window.addEventListener("online",e),window.addEventListener("offline",e),e()}async createUserProfile(e){let t=(0,a.H9)(i.db,"users",e.uid),r=Object.fromEntries(Object.entries(e).filter(e=>{let[t,r]=e;return null!=r}));await (0,a.BN)(t,{...r,createdAt:(0,a.O5)(),updatedAt:(0,a.O5)()})}async getUserProfile(e){let t=(0,a.H9)(i.db,"users",e),r=await s(()=>(0,a.x7)(t),"getUserProfile(".concat(e,")"));if(r.exists()){var o,l;let e=r.data();return{...e,createdAt:(null===(o=e.createdAt)||void 0===o?void 0:o.toDate())||new Date,updatedAt:(null===(l=e.updatedAt)||void 0===l?void 0:l.toDate())||new Date}}return null}async updateUserProfile(e,t){let r=(0,a.H9)(i.db,"users",e);await (0,a.mZ)(r,{...t,updatedAt:(0,a.O5)()})}async updateContentPreferences(e,t){let r=(0,a.H9)(i.db,"users",e);await (0,a.mZ)(r,{contentPreferences:t,updatedAt:(0,a.O5)()})}async getUserContentPreferences(e){let t=await this.getUserProfile(e);return(null==t?void 0:t.contentPreferences)||null}async createPlaylist(e){let t=Object.fromEntries(Object.entries(e).filter(e=>{let[t,r]=e;return void 0!==r}));return(await (0,a.gS)((0,a.rJ)(i.db,"users",e.createdBy,"playlists"),{...t,createdAt:(0,a.O5)(),updatedAt:(0,a.O5)()})).id}async getPlaylist(e){let t=(0,a.rJ)(i.db,"users");for(let l of(await s(()=>(0,a.GG)(t),"getPlaylist:users")).docs){let t=(0,a.rJ)(i.db,"users",l.id,"playlists"),n=(0,a.P)(t,(0,a._M)("__name__","==",e)),c=await s(()=>(0,a.GG)(n),"getPlaylist:".concat(e));if(!c.empty){var r,o;let e=c.docs[0].data();return{id:c.docs[0].id,...e,createdAt:(null===(r=e.createdAt)||void 0===r?void 0:r.toDate())||new Date,updatedAt:(null===(o=e.updatedAt)||void 0===o?void 0:o.toDate())||new Date}}}return null}async getUserPlaylists(e){let t=(0,a.rJ)(i.db,"users",e,"playlists"),r=(0,a.P)(t,(0,a.My)("updatedAt","desc"));return(await s(()=>(0,a.GG)(r),"getUserPlaylists(".concat(e,")"))).docs.map(e=>{var t,r;let a=e.data();return{id:e.id,...a,createdAt:(null===(t=a.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(r=a.updatedAt)||void 0===r?void 0:r.toDate())||new Date}})}async updatePlaylist(e,t){if(!await this.getPlaylist(e))throw Error("Playlist not found");let r=(0,a.rJ)(i.db,"users");for(let o of(await s(()=>(0,a.GG)(r),"updatePlaylist:users")).docs){let r=(0,a.H9)(i.db,"users",o.id,"playlists",e);if((await s(()=>(0,a.x7)(r),"updatePlaylist:locate")).exists()){await (0,a.mZ)(r,{...t,updatedAt:(0,a.O5)()});return}}throw Error("Playlist not found")}async deletePlaylist(e){let t=(0,a.rJ)(i.db,"users");for(let r of(await s(()=>(0,a.GG)(t),"deletePlaylist:users")).docs){let t=(0,a.H9)(i.db,"users",r.id,"playlists",e);if((await s(()=>(0,a.x7)(t),"deletePlaylist:locate")).exists()){await (0,a.kd)(t);return}}throw Error("Playlist not found")}async addTrackToPlaylist(e,t){let r=(0,a.rJ)(i.db,"users");for(let o of(await s(()=>(0,a.GG)(r),"addTrackToPlaylist:users")).docs){let r=(0,a.H9)(i.db,"users",o.id,"playlists",e),l=await s(()=>(0,a.x7)(r),"addTrackToPlaylist:locate");if(l.exists()){let e=[...l.data().tracks,t];await (0,a.mZ)(r,{tracks:e,trackCount:e.length,updatedAt:(0,a.O5)()});return}}throw Error("Playlist not found")}async removeTrackFromPlaylist(e,t){let r=(0,a.rJ)(i.db,"users");for(let o of(await s(()=>(0,a.GG)(r),"removeTrackFromPlaylist:users")).docs){let r=(0,a.H9)(i.db,"users",o.id,"playlists",e),l=await s(()=>(0,a.x7)(r),"removeTrackFromPlaylist:locate");if(l.exists()){let e=l.data().tracks.filter(e=>e!==t);await (0,a.mZ)(r,{tracks:e,trackCount:e.length,updatedAt:(0,a.O5)()});return}}throw Error("Playlist not found")}async addToFavorites(e,t){let r=(0,a.rJ)(i.db,"users",e,"favorites");await (0,a.gS)(r,{trackId:t,addedAt:(0,a.O5)()})}async removeFromFavorites(e,t){let r=(0,a.rJ)(i.db,"users",e,"favorites"),o=(0,a.P)(r,(0,a._M)("trackId","==",t)),l=await s(()=>(0,a.GG)(o),"removeFromFavorites(".concat(e,", ").concat(t,")")),n=(0,a.wP)(i.db);l.docs.forEach(e=>{n.delete(e.ref)}),await n.commit()}async getUserFavorites(e){let t=(0,a.rJ)(i.db,"users",e,"favorites"),r=(0,a.P)(t,(0,a.My)("addedAt","desc"));return(await s(()=>(0,a.GG)(r),"getUserFavorites(".concat(e,")"))).docs.map(e=>e.data().trackId)}async isTrackFavorited(e,t){let r=(0,a.rJ)(i.db,"users",e,"favorites"),o=(0,a.P)(r,(0,a._M)("trackId","==",t));return!(await s(()=>(0,a.GG)(o),"isTrackFavorited(".concat(e,", ").concat(t,")"))).empty}async addToHistory(e,t){let r=(0,a.rJ)(i.db,"users",e,"history");await (0,a.gS)(r,{trackId:t,playedAt:(0,a.O5)()});let o=(0,a.P)(r,(0,a.My)("playedAt","desc")),s=await (0,a.GG)(o);if(s.docs.length>50){let t=(0,a.wP)(i.db),r=s.docs.slice(50);r.forEach(e=>{t.delete(e.ref)}),await t.commit(),console.debug("[FirebaseService] Cleaned up ".concat(r.length," old history entries for user ").concat(e))}}async getUserHistory(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,r=(0,a.rJ)(i.db,"users",e,"history"),o=(0,a.P)(r,(0,a.My)("playedAt","desc"),(0,a.AB)(t));return(await s(()=>(0,a.GG)(o),"getUserHistory(".concat(e,")"))).docs.map(e=>e.data().trackId)}async addToLibrary(e,t,r){let o=(0,a.rJ)(i.db,"users",e,"library");await (0,a.gS)(o,{type:t,itemId:r,addedAt:(0,a.O5)()})}async removeFromLibrary(e,t,r){let o=(0,a.rJ)(i.db,"users",e,"library"),l=(0,a.P)(o,(0,a._M)("type","==",t),(0,a._M)("itemId","==",r)),n=await s(()=>(0,a.GG)(l),"removeFromLibrary(".concat(e,", ").concat(t,", ").concat(r,")")),c=(0,a.wP)(i.db);n.docs.forEach(e=>c.delete(e.ref)),await c.commit()}async getUserLibrary(e,t){let r;let o=(0,a.rJ)(i.db,"users",e,"library");r=t?(0,a.P)(o,(0,a._M)("type","==",t)):(0,a.P)(o,(0,a.My)("addedAt","desc"));let l=(await s(()=>(0,a.GG)(r),"getUserLibrary(".concat(e,", ").concat(t||"all",")"))).docs.map(e=>{var t;let r=e.data();return{id:e.id,...r,addedAt:(null===(t=r.addedAt)||void 0===t?void 0:t.toDate())||new Date}});return t&&l.sort((e,t)=>t.addedAt.getTime()-e.addedAt.getTime()),l}async deleteUserAccount(e){let t=(0,a.wP)(i.db);try{console.log("[FirebaseService] Starting complete account deletion for user: ".concat(e));let r=(0,a.H9)(i.db,"users",e);t.delete(r);let o=(0,a.rJ)(i.db,"users",e,"playlists");(await s(()=>(0,a.GG)(o),"deleteUserAccount:playlists(".concat(e,")"))).docs.forEach(e=>{t.delete(e.ref)});let l=(0,a.rJ)(i.db,"users",e,"favorites");(await s(()=>(0,a.GG)(l),"deleteUserAccount:favorites(".concat(e,")"))).docs.forEach(e=>{t.delete(e.ref)});let n=(0,a.rJ)(i.db,"users",e,"history");(await s(()=>(0,a.GG)(n),"deleteUserAccount:history(".concat(e,")"))).docs.forEach(e=>{t.delete(e.ref)});let c=(0,a.rJ)(i.db,"users",e,"library");(await s(()=>(0,a.GG)(c),"deleteUserAccount:library(".concat(e,")"))).docs.forEach(e=>{t.delete(e.ref)}),await t.commit(),console.log("[FirebaseService] Successfully deleted all Firestore data for user: ".concat(e))}catch(t){throw console.error("[FirebaseService] Error deleting user account data for ".concat(e,":"),t),Error("Failed to delete user account data: ".concat(t))}}}let n=new l},3999:(e,t,r)=>{r.d(t,{cn:()=>o});var a=r(2596),i=r(9688);function o(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,i.QP)((0,a.$)(t))}},5683:(e,t,r)=>{r.d(t,{AuthProvider:()=>y,A:()=>g});var a=r(5155),i=r(2115),o=r(5404),s=r(8915),l=r(2401);let n="profile_img_";async function c(e,t){if(!e)return"";try{var r;let a=d(t);if(a&&a.originalUrl===e)return a.dataUrl;let i=await fetch(e),o=await i.blob(),s=await (r=o,new Promise((e,t)=>{let a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(r)})),l={dataUrl:s,timestamp:Date.now(),originalUrl:e};try{localStorage.setItem(n+t,JSON.stringify(l))}catch(e){!function(){try{let e=Object.keys(localStorage),t=Date.now();e.forEach(e=>{if(e.startsWith(n))try{let r=JSON.parse(localStorage.getItem(e)||"{}");t-r.timestamp>6048e5&&localStorage.removeItem(e)}catch(t){localStorage.removeItem(e)}})}catch(e){console.error("Error clearing expired caches:",e)}}();try{localStorage.setItem(n+t,JSON.stringify(l))}catch(e){console.warn("Failed to cache profile image")}}return s}catch(t){return console.error("Error caching profile image:",t),e}}function d(e){try{let t=localStorage.getItem(n+e);if(!t)return null;let r=JSON.parse(t);if(Date.now()-r.timestamp>6048e5)return localStorage.removeItem(n+e),null;return r}catch(e){return console.error("Error reading cached image:",e),null}}function u(e,t){if(!e||!t)return;let r=d(t);(!r||r.originalUrl!==e)&&c(e,t).catch(e=>{console.warn("Background image caching failed:",e)})}let f=(0,i.createContext)({user:null,isLoading:!0,signIn:async()=>!1,signUp:async()=>!1,signInWithGoogle:async()=>!1,signOut:()=>{},deleteAccount:async()=>!1,addToFavorites:async()=>{},removeFromFavorites:async()=>{},favoriteTrackIds:[],refreshFavorites:async()=>{},followArtist:async()=>{},unfollowArtist:async()=>{},followedArtistIds:[],refreshFollowedArtists:async()=>{},likeAlbum:async()=>{},unlikeAlbum:async()=>{},likedAlbumIds:[],refreshLikedAlbums:async()=>{},addToHistory:async()=>{},historyTrackIds:[],refreshHistory:async()=>{},contentPreferences:null,updateContentPreferences:async()=>{},showPreferenceOverlay:!1});function y(e){let{children:t}=e,[r,n]=(0,i.useState)(null),[c,d]=(0,i.useState)(!0),[y,g]=(0,i.useState)([]),[m,p]=(0,i.useState)([]),[h,w]=(0,i.useState)([]),[b,v]=(0,i.useState)([]),[A,P]=(0,i.useState)(null),[S,U]=(0,i.useState)(!1);(0,i.useEffect)(()=>{let e=!0;console.log("[Auth] Setting up auth state listener...");let t=(0,o.hg)(s.j2,async t=>{if(console.log("[Auth] Auth state changed:",t?{uid:t.uid,email:t.email,displayName:t.displayName}:null),!e){console.log("[Auth] Component unmounted, skipping state update");return}if(t){let e=await l.firebaseService.getUserProfile(t.uid),r=t.displayName||(null==e?void 0:e.displayName)||"User",a=t.photoURL||(null==e?void 0:e.photoURL)||void 0,i=t.email||(null==e?void 0:e.email)||"";if(e){(e.displayName!==r||e.photoURL!==a||e.email!==i)&&await l.firebaseService.updateUserProfile(t.uid,{displayName:r,email:i,photoURL:a}),n({uid:t.uid,displayName:r,email:i,photoURL:a}),a&&u(a,t.uid),g(await l.firebaseService.getUserFavorites(t.uid)),p((await l.firebaseService.getUserLibrary(t.uid,"artist")).map(e=>e.itemId)),w((await l.firebaseService.getUserLibrary(t.uid,"album")).map(e=>e.itemId)),v(await l.firebaseService.getUserHistory(t.uid));let o=await l.firebaseService.getUserContentPreferences(t.uid);P(o),o&&o.hasSetPreferences||U(!0)}else await l.firebaseService.createUserProfile({uid:t.uid,displayName:r,email:i,photoURL:a}),n({uid:t.uid,displayName:r,email:i,photoURL:a}),a&&u(a,t.uid),U(!0)}else n(null),g([]),p([]),w([]),v([]);d(!1)});return()=>{console.log("[Auth] Cleaning up auth listener"),e=!1,t()}},[]);let k=async(e,t)=>{try{return await (0,o.x9)(s.j2,e,t),!0}catch(e){throw console.error("Sign in error:",e),e}},F=async(e,t,r)=>{try{let a=(await (0,o.eJ)(s.j2,t,r)).user;return await l.firebaseService.createUserProfile({uid:a.uid,displayName:e,email:a.email||"",photoURL:a.photoURL||void 0}),!0}catch(e){return console.error("Sign up error:",e),!1}},G=async()=>{try{console.log("[Auth] Starting Google sign-in with popup...");let e=(await (0,o.df)(s.j2,s.hJ)).user;return console.log("[Auth] Google sign-in successful:",{uid:e.uid,email:e.email,displayName:e.displayName}),await l.firebaseService.getUserProfile(e.uid)||(console.log("[Auth] Creating new user profile..."),await l.firebaseService.createUserProfile({uid:e.uid,displayName:e.displayName||"User",email:e.email||"",photoURL:e.photoURL||void 0})),!0}catch(e){if("auth/popup-closed-by-user"===e.code)return console.log("[Auth] User closed the sign-in popup"),!1;if("auth/popup-blocked"===e.code)throw console.error("[Auth] Popup was blocked by browser"),Error("Please allow popups for this site to sign in with Google");throw console.error("[Auth] Google sign-in error:",e),e}},E=async()=>{try{await (0,o.CI)(s.j2)}catch(e){console.error("Sign out error:",e)}},L=async()=>{if(!r)return!1;try{await l.firebaseService.deleteUserAccount(r.uid);let e=s.j2.currentUser;return e&&await (0,o.hG)(e),n(null),g([]),p([]),w([]),v([]),P(null),U(!1),!0}catch(e){throw console.error("Delete account error:",e),e}},x=async e=>{if(r)try{await l.firebaseService.addToFavorites(r.uid,e),y.includes(e)||g(t=>[...t,e])}catch(e){console.error("Error adding to favorites:",e)}},I=async e=>{if(r)try{await l.firebaseService.removeFromFavorites(r.uid,e),g(t=>t.filter(t=>t!==e))}catch(e){console.error("Error removing from favorites:",e)}},J=async()=>{if(r)try{let e=await l.firebaseService.getUserFavorites(r.uid);g(e)}catch(e){console.error("Error refreshing favorites:",e)}},T=async e=>{if(r)try{await l.firebaseService.addToLibrary(r.uid,"artist",e),m.includes(e)||p(t=>[...t,e])}catch(e){console.error("Error following artist:",e)}},O=async e=>{if(r)try{await l.firebaseService.removeFromLibrary(r.uid,"artist",e),p(t=>t.filter(t=>t!==e))}catch(e){console.error("Error unfollowing artist:",e)}},N=async()=>{if(r)try{let e=await l.firebaseService.getUserLibrary(r.uid,"artist");p(e.map(e=>e.itemId))}catch(e){console.error("Error refreshing followed artists:",e)}},D=async e=>{if(r)try{await l.firebaseService.addToLibrary(r.uid,"album",e),h.includes(e)||w(t=>[...t,e])}catch(e){console.error("Error liking album:",e)}},H=async e=>{if(r)try{await l.firebaseService.removeFromLibrary(r.uid,"album",e),w(t=>t.filter(t=>t!==e))}catch(e){console.error("Error unliking album:",e)}},_=async()=>{if(r)try{let e=await l.firebaseService.getUserLibrary(r.uid,"album");w(e.map(e=>e.itemId))}catch(e){console.error("Error refreshing liked albums:",e)}},C=async e=>{if(r)try{await l.firebaseService.addToHistory(r.uid,e),v(t=>[e,...t.filter(t=>t!==e)])}catch(e){console.error("Error adding to history:",e)}},j=async()=>{if(r)try{let e=await l.firebaseService.getUserHistory(r.uid);v(e)}catch(e){console.error("Error refreshing history:",e)}},R=async e=>{if(r)try{await l.firebaseService.updateContentPreferences(r.uid,e),P(e),U(!1)}catch(e){console.error("Error updating content preferences:",e)}};return(0,a.jsx)(f.Provider,{value:{user:r,isLoading:c,signIn:k,signUp:F,signInWithGoogle:G,signOut:E,deleteAccount:L,addToFavorites:x,removeFromFavorites:I,favoriteTrackIds:y,refreshFavorites:J,followArtist:T,unfollowArtist:O,followedArtistIds:m,refreshFollowedArtists:N,likeAlbum:D,unlikeAlbum:H,likedAlbumIds:h,refreshLikedAlbums:_,addToHistory:C,historyTrackIds:b,refreshHistory:j,contentPreferences:A,updateContentPreferences:R,showPreferenceOverlay:S},children:t})}function g(){return(0,i.useContext)(f)}},7168:(e,t,r)=>{r.d(t,{$:()=>c});var a=r(5155),i=r(2115),o=r(9708),s=r(2085),l=r(3999);let n=(0,s.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),c=i.forwardRef((e,t)=>{let{className:r,variant:i,size:s,asChild:c=!1,...d}=e,u=c?o.DX:"button";return(0,a.jsx)(u,{className:(0,l.cn)(n({variant:i,size:s,className:r})),ref:t,...d})});c.displayName="Button"},8915:(e,t,r)=>{r.d(t,{db:()=>c,hJ:()=>d,j2:()=>n});var a=r(3915),i=r(5404),o=r(5317),s=r(7505);let l=(0,a.Wp)({apiKey:"AIzaSyCpI2GRtLXksYu-p9SoFvr1FwM99sOkcSw",authDomain:"music-streaming-app-dcd57.firebaseapp.com",projectId:"music-streaming-app-dcd57",storageBucket:"music-streaming-app-dcd57.firebasestorage.app",messagingSenderId:"10885097238",appId:"1:10885097238:web:caa03da858ec3225f49237",measurementId:"G-YQVQTS2X6H"}),n=(0,i.xI)(l);(0,i.oM)(n,i.F0).catch(e=>{console.error("Error setting auth persistence:",e)});let c=(0,o.aU)(l);(0,s.c7)(l);let d=new i.HF;d.setCustomParameters({prompt:"select_account"})}}]);